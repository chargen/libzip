changeset:   1718:9f11d54f692e
user:        Thomas Klausner <tk@giga.or.at>
date:        Sat Mar 21 12:28:42 2015 +0100
summary:     Avoid integer overflow. Addresses CVE-2015-2331.

diff -r fa78ab51417f -r 9f11d54f692e lib/zip_dirent.c
--- a/lib/zip_dirent.c	Wed Mar 11 18:17:53 2015 +0100
+++ b/lib/zip_dirent.c	Sat Mar 21 12:28:42 2015 +0100
@@ -105,7 +105,7 @@
 
     if (nentry == 0)
 	cd->entry = NULL;
-    else if ((cd->entry=(struct zip_entry *)malloc(sizeof(*(cd->entry))*(size_t)nentry)) == NULL) {
+    else if ((nentry > SIZE_MAX/sizeof(*(cd->entry))) || (cd->entry=(struct zip_entry_t *)malloc(sizeof(*(cd->entry))*(size_t)nentry)) == NULL) {
 	_zip_error_set(error, ZIP_ER_MEMORY, 0);
 	free(cd);
 	return NULL;
